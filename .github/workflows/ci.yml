name: ci
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      # ---------- Java (API) ----------
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ runner.os }}-${{ hashFiles('api/pom.xml') }}
          restore-keys: m2-

      - name: API build & tests
        run: mvn -q -f api/pom.xml -DskipTests=false test

      # ---------- Python (ML) ----------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Python lint (ruff)
        run: ruff check ml

      # ---------- Node (Web) ----------
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web/node_modules
          key: node-${{ runner.os }}-${{ hashFiles('web/package-lock.json') }}
          restore-keys: node-

      - name: Install & build web
        working-directory: web
        run: |
          npm ci
          npm run build

      # ---------- Docker builds (smoke) ----------
      - name: Docker build images
        run: |
          docker build -t tes-ml ./ml
          docker build -t tes-api ./api
          docker build -t tes-web ./web

      # ---------- Security scan (optional, non-blocking) ----------
      - name: Run Trivy scan (optional)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: tes-api
          format: 'table'
          exit-code: '0'   # keep CI green on MVP
          ignore-unfixed: true