services:
  ml:
    build:
      context: ..
      dockerfile: ml/Dockerfile
    container_name: tes-ml
    working_dir: /app
    environment:
      - LOG_LEVEL=info
      - PYTHONPATH=/app
      - DATA_PATH=/app/ml/data/got.yaml
    command: uvicorn ml.app:app --host 0.0.0.0 --port 8000 --log-level info --proxy-headers
    ports:
      - "8000:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,sys; urllib.request.urlopen('http://127.0.0.1:8000/health'); sys.exit(0)"]
      interval: 5s
      timeout: 3s
      retries: 20

  api:
    build: ../api
    container_name: tes-api
    depends_on:
      ml:
        condition: service_healthy
    ports:
      - "8080:8080"
      - "5005:5005"
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:5173,http://localhost:3000}
      - API_PORT=${API_PORT:-8080}
      - ML_BASE_URL=${ML_BASE_URL:-http://ml:8000}
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8081/actuator/health/readiness" ]
      interval: 10s
      timeout: 3s
      retries: 5

  web:
    build: ../web
    container_name: tes-web
    depends_on: [api]
    ports: ["5173:80"]
    environment:
      - VITE_API_BASE=http://localhost:8080
    restart: unless-stopped